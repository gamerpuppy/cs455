package cs455.hadoop;

import cs455.hadoop.util.CsvTokenizer;
import cs455.hadoop.wireformats.CustomWritable;
import cs455.hadoop.wireformats.CustomWritableComparable;
import cs455.hadoop.wireformats.MetadataQ1Value;
import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.io.Writable;
import org.apache.hadoop.mapreduce.Mapper;

import java.io.IOException;
import java.util.HashMap;

public class MetadataMapper extends Mapper<LongWritable, Text, CustomWritableComparable, CustomWritable> {

    // Question 1
    private HashMap<String, MetadataQ1Value> q1Map = new HashMap<>();

    // Question 2


    // Question 3
    private String maxHotnessTitle = null;
    private Double maxHotness = null;

    protected void map(LongWritable byteOffset, Text value, Context context) throws IOException, InterruptedException
    {
        if(value.charAt(0) != '0')
            return;

        CsvTokenizer csv = new CsvTokenizer(value.toString());

        Double hotness = Double.parseDouble(csv.getTokAt(2));
        String artistId = csv.getTokAt(3);
        String artistName = csv.getTokAt(7);
        String songTitle = csv.getTokAt(9);

        // Question 1
        mapQ1(artistId, artistName);

        // Question 3
//        mapQ3(songTitle, hotness);
    }


    private void mapQ1(String artistId, String artistName) {
        if(q1Map.containsKey(artistId)) {
            q1Map.get(artistId).addToSongCount(1);

        } else {
            MetadataQ1Value value = new MetadataQ1Value(artistName, 1);
            q1Map.put(artistId, value);

        }
    }

    @Override
    protected void cleanup(Context context) throws IOException, InterruptedException {
        // Question 1
        cleanupQ1(context);

        // Question 3
//        cleanupQ3(context);

    }

    private void cleanupQ1(Context context) throws IOException, InterruptedException {
        for (String artistId : q1Map.keySet())
        {
            CustomWritableComparable key = new CustomWritableComparable(CustomWritableComparable.METADATAQ1KEY, new Text(artistId));
            CustomWritable value = new CustomWritable(CustomWritable.METADATAQ1VALUE, q1Map.get(artistId));
            context.write(key, value);
        }
    }
//
//    public static void main(String[] args) throws Exception {
//        Text input = new Text("0,0.5330698267563518,0.4153668495249416,b'ARN80361187FB36732',,,b'',b'Stomper 98',b'SOZCBIS12AB0188B17',b'A way of life',ARR7NQ71187B9A57C0 AREX1H91187FB394F4 ARO0MU01187B993860 ARRK2K31187B9B3ED3 AR28ZEO1187FB4F258 ARPL46W1187B99A913 ARBEPDL1187FB3E8FC ARTOKRP1269FB361FD ARUBTLM1187FB3EF78 ARTV44B1187FB5B2E0 AR59VS71187FB557A8 ARCVE8X1187FB511AD ARC801F1187FB496DA ARGWNDG1187FB3A79C AREYDSV1187FB5B7DE ARCWYQY12086C16BC3 ART9M7Z1187B9A03EF ARXULZD1187FB4E166 AR7CHAS1187B989CA9 ARXT5VN1187FB4A0A2 ARAOED11187B99A911 AR4MNMT1187B99EA61 ARXVYAQ122BCFCCFF1 ARW9NPM1187B9911AF ARPAD9R1187B989D84 ARSIO0M1187B99A950 ARBTSFR1187B9A8D8F AR0NP5K11C8A4159E5 ARLF4991187B993857 ARHHAYP1269FB361FC ARE2BR01187FB366A0 AR06CPZ1187B9A5B31 AR8SN6F1187FB44151 ARXRBC31187B99364F AR3MOF21187B99DC79 ARMN8RA1187FB3BE15 AROYJXB11F4C83C0A8 AR2WWR51187B9B481E AREDRIA1187B9B0C5C ARDBV1S1187FB51AE5 ARDZUZE11F50C4B83F AREKZLX1269FB361CB ARGS3711187FB3FC62 ARRA2DK1187FB4A014 ARAF6L21187FB3B03D ARGBVZH11C8A415829 ARPDFFY11F4C8461B4 AR5GW5N1187FB534A2 ARCL1RZ1187B98A56F ARNLGTA1187FB37738 ARSDIYU122988FF159 ARH0K4B1187B9A15C1 ARJ27SR11C8A41582A ARBUOKX1187B9975C3 ARY8WOW1187FB3CBBE AR4XE2W1187B99822D ARLRLEO12AF7DA648D ARHFAYI12086C12F87 ARGMOGR122ECCB9224 AR4KBGK1187B99E8E2 ARWJWYZ12086C16BC5 ARATWSH1187B99DD9D ARRXADQ1187FB38F22 ARZCVXI11F50C4B848 ARBTDLC1269FB36828 ARES2GC1187B99E6E2 ARPPXGE1187FB48588 ARDD0IN1187FB47F75 ARCAETZ1187B9A1C4E ARLDW3T1187FB40AC3 ARI97YW1187B9A2FE4 ARWIGLE11F4C83C091 ARHS9RV1187B991681 ARDLJWX11F50C4B843 ARY61HD1187B99E4EE ARDMC081187B9946BF AR494FD1187FB43542 ARA0NWZ1187B9935FE AR7MKGQ1187B99DFCB ARKGG4G1187B98A8BB ARZWPPJ12AF7D99F0A ARQIH591187B9A5928 ARKGW7Q1187B991F2A ARE30F21187FB4BC5F AR9CNXM1187FB380EB AR2GYZS1187B98C9FC AROCM4Y1187B9981E0 ARVZTU71187B9AEA66 ARJCB471187B99C0C6 ARVWN671187B99E4A2 AR0MUJ71187FB44432 AR06S8I1187B9B5856 ARWF7LO1187B99E44D ARKRZOH1187FB3C589 ARVM5XH1187FB3C5F7 AR064Q51187B99339B ARUAFPM1187B99C540 ARLDTZ61187B99A07F ARHLYXD11F50C4B49E ARTVYPZ12454A2E9BD,oi ska hard house hardstyle hip hop trip hop hard rock blues-rock hyphy progressive house rock hardcore punk downtempo trance electronic alternative rock techno heavy metal classic rock gangsta punk house street punk german germany skinhead psychedelic trance experimental abstract german punk pop ambient latin classical noise italy india contemporary united states drum and bass italian dance antifa euro-house sharp,0.9736979364891073 0.9513328426578251 0.8053313706313006 0.8053313706313006 0.967000167904575 0.8053313706313006 0.9250249161878417 0.7566642132891257 0.7566642132891257 0.7566642132891257 1.0 0.8053313706313006 0.8337998326931692 0.8696658532202253 0.9331316863673378 0.8338169316222589 0.8053313706313006 0.7566642132891257 0.7566642132891257 0.6031902240820668 0.7706715445051044 0.7036464306302423 0.537565723404359 0.6800644924806346 0.5910769990323955 0.4956085854254959 0.5310628759933185 0.698395890778154 0.4872179720279528 0.4578249804424678 0.6803519251604636 0.6393789745932287 0.5530867600231202 0.5824809900004945 0.5659233887467676 0.44602996742691386 0.4146264780152176 0.41109552845239106 0.39487276662895443 0.49976920386089024 0.34645862529590593 0.3076702692997989 0.28977380868379504 0.2516055534924366,1.0 0.9115769189496777 0.8953948624661422 0.8953948624661422 0.8856447727876575 0.8721091746238242 0.8592661629257762 0.856786267741339 0.856786267741339 0.8250769501365899 0.8238339594091403 0.8149977931131546 0.8113700985469063 0.8111192728318589 0.785881466017147 0.7679726730811748 0.7559224546153614 0.7419651347822281 0.740103749598051 0.7350323915403301 0.6899223926857719 0.6774932983037938 0.6684431663256922 0.6670273235502565 0.661458905780653 0.6496858023093559 0.6471210261041037 0.6388844047933798 0.6388458484690138 0.6197113396183201 0.6002755133512603 0.600271236964048 0.6002684173894949 0.600265880796514 0.6002645480175879 0.6001987394899365 0.5854411343296542 0.5826399639283012 0.5697701340314295 0.5663733532421861 0.5313622617874271 0.5005907107357427 0.4863931033005346 0.45611349017920294,0\n");
//
//        new MetadataMapper().map(new LongWritable(100), new Text("0,,0.36987010703120304,b'ARID1TK1187FB4CFB8',,,b'',b'All Girl Summer Fun Band',b'SOKUPZU12AB018379B',b'Everything I Need',AR3K4BX1187B998E60 ARH27D81187FB3BDE3 ARBBHHE1187FB461D4 AR9BSIB1187FB37E5A ARVD7C11187B9AD8A8 ARA2W071187FB4D951 ARVHWZZ1187FB4D84C AR9TV541187B993172 ARGGPT11187B98D573 ARQLQVP1187FB4E0F0 ARFGZFW1187FB4B12F ARMRYMG11F4C83F264 ARSVQJO1187FB4FE4F ARPRVZJ1187B98ABF8 ARP6QCL1187FB36142 ARBJBER1187B9B6692 AR1USMR1187B9B6CD1 ARP31W61187B9A4172 AR3G7HW1187B98D08A ARKGLPW1187B99FB46 AR2CDP71187B993373 ARYDOQU11F4C84252F ARCJL1K1187B9B5AEF ARIDQH31187B9ACB84 ARUN1FS1187B98E596 ARWKFPM1187FB4E712 ARAKX3J1187B99079A ARDJRZJ1187B99BBAF AR85HP41187FB4D184 ART3CAU1187FB4CE73 ARS4TF91187FB4AC5B AROJWKL11F4C84831B ARLF0QY1187FB4FDCC ARBV8MM1187B9AD204 ARBW47O1187FB379DA ARR2TI31187FB380FE ARL26PR1187FB576E5 ARQAQWE1187FB49906 ARL0ECH1187B9B1BC6 ARP3DCU1187B9ADB18 AR59C6A1187B9B2143 AR8VOKE1187FB4D0B4 AR5SZEA1187B9BA0AA AROLJZM1187B994C58 AR7RETP1187B994606 ARRTBLX11F50C4EBA1 ARG8AIV1187FB546F5 ARK0SQJ1187B9942CF ARXNW1T1187B9B5FB9 ARQSHQE1187FB4D817 AR2O20V1187B989AF6 AR5UA0T1187B9A6773 ARZBDBS11F4C847F7E ARSBQOU1187FB4DABF ARO77OC1187FB42D94 ARK24KH1187B9B6B93 ARCNQN41187FB41CDA ARDXEPD1187B98C933 ARAJPHH1187FB5566A ARCWWWS1187B989B23 ARILB0K1187FB53C60 ARDVHCZ1187B98CA5B AR39N7E1187FB37512 AR7ACND1187FB42B05 ARNZGU21187B9ACB09 ARQJ9VM1187FB420BE ARWSMC91187B9AD369 ARZXCSZ11F50C4D59C ARBRL2P1187B9AF9E4 AREMOJR11F4C83D6C9 AR9ACXC1187B9B5496 AR8NPQ31187B990726 ARDKPZ91187FB40C25 ARQQFFR12472CE34B2 AR5MOHS1187B9B5F41 AR44JUQ1187B98FD6D ARD914N1187FB56BDD ARBVBAZ11E2835CC1A ARAPLNH1187FB532A0 ARC4V2K1187FB3C5AE AR5OYUJ1187FB38DE9 ARCHKD91187B9A0A42 ARLRCST11F50C4A0A1 ARKCQ6O1187FB47A1C AR67UCD1187B9B1585 AROTXWF1187B9A9103 ARIGGCC11C8A415404 ARMKXH91187B99FCC0 ARSWQOY1187B9A5458 ARQDABG11F4C840F64 ARCIAJV1187FB37ECC ARV5WFJ1187B989B3C ARFOZ9U1187FB4F625 ARCYJTW11F4C840F74 ARXVCQ91187FB55765 AROQCSJ11F4C847A75 AR0843S1187B988C21 ARALP6I1187B989E27 ARTCN1S1187B9A417F ARSBUYK12086C12A98,pop rock twee pop indie rock indie pop cuddlecore rock lo-fi female vocalist alternative rock dance pop indie twee united states punk pop electronic alternative acoustic ambient american female 00s female vocals retro italy abstract portland c86 harsh noise oregon cheerful all-female happy music delicate k records,0.9949118741689748 0.8497227932012054 0.9983476443594967 0.9095896271326792 0.7592468993791327 1.0 0.7813618195322073 0.7402605089807 0.759295482561222 0.7592468993791327 0.7787885062400272 0.7669560686905709 0.5692859902405791 0.4948176090066175 0.4643953484819998 0.7058052016332854 0.688891591875618 0.6053657594573197 0.6502296612554627 0.6289958411412327 0.5793784420348419 0.5913185381168805 0.5352061363821851 0.4692471189047171 0.4705626865279109 0.4635415072057936 0.38954508263020754 0.3848751622633082 0.38003853794455045 0.3505123367861994 0.3474039130457875 0.3283093259405308 0.3220462783106622 0.30557724221289395 0.26935561658717,1.0 0.9622964148449695 0.9309809609762243 0.8898712449096764 0.8866062875084691 0.8664890396638236 0.833777018499868 0.7702654120956581 0.7395934279334136 0.7320381772140864 0.7108591739718486 0.695151707092314 0.6951435991789138 0.6653906043657702 0.6399400155326734 0.6351690918764038 0.6351682962842442 0.6351677766264214 0.6351673161595884 0.6351663634747502 0.635165775612508 0.6351642553790781 0.6351625329716194 0.6351473905983117 0.6351449200046021 0.6351249265429952 0.5773219422077001 0.5734151903394394 0.5693689776401151 0.5446680122113161 0.542067573809566 0.5260934654766104 0.5208539386524645 0.5070763080959662 0.47677409896457384,2008\n"), null);
//    }

}
